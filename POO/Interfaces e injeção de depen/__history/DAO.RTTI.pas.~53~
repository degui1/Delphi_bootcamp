unit DAO.RTTI;

interface

uses
  System.RTTI, System.SysUtils;

type
  TableName = class(TCustomAttribute)
    private
    FTableName: String;
    procedure SetTableName(const Value: String);
    public
      constructor Create ( aTableName : String );
      property TableName: String read FTableName write SetTableName;
  end;




  TDAORTTI = class
    private
    public
      class function getInsertSQL<T : class> ( aEntity: T ) : String;
  end;
implementation

{ TDAORTTI }

class function TDAORTTI.getInsertSQL<T>(aEntity: T): String;
var
  ctx : TRttiContext;
  _type : TRttiType;
  props : TRttiProperty;
  attr : TCustomAttribute;
  FTableName : String;
begin
  ctx := TRttiContext.Create;
  try
    _type := ctx.GetType(aEntity.ClassInfo);

    for attr in _type.GetAttributes do
        if attr is TableName then
          FTableName := TableName(attr).TableName;


    Result := 'INSERT INTO ' + FTableName + '(';

    for props in _Type.GetProperties do
    begin
      Result := Result + props.Name + ',';
    end;

    Result := Copy(Result, 0, Length(Result) -1);

    Result := Result + ') VALUES (';

    for props in _Type.GetProperties do
    begin
      Result := Result + QuotedStr(props.GetValue(Pointer(aEntity)).AsString) + ',';
    end;

    Result := Copy(Result, 0, Length(Result) -1);

    Result := Result + ')';
  finally
    ctx.Free;
  end;
end;

{ TableName }

constructor TableName.Create(aTableName: String);
begin
  FTableName :=aTableName;
end;

procedure TableName.SetTableName(const Value: String);
begin
  FTableName := Value;
end;

end.
